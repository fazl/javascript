<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Basic Tic Tac Toe</title>
  <meta name="description" content="Basic Tic Tac Toe">
  <meta name="author" content="Fazl">

  <link rel="stylesheet" href="css/styles.css?v=1.0">

  <!-- inline styles take precedence over external -->
  <style type="text/css">
    button{
      width: 130px;
      height: 130px;
      outline: none;
      border: none;
    }
    button.active{
      background-color: #2a609a;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    button.active:hover{
      background-color: #32CD32;
      font-size: 20px;
      transition: 0.5s;
    }
    button.locked{
      background-color: #32CD32;
      font-size: 20px;
    }
  </style>

  <script>
    const o = 'O';
    const x = 'X';
    let player=x;
    let activeButtons=-1;
    const winConfigs = [
      [0,1,2],//horiz
      [3,4,5],//horiz
      [6,7,8],//horiz
      [0,3,6],//vert
      [1,4,7],//vert
      [2,5,8],//vert
      [0,4,8],//diag
      [2,4,6] //diag
    ];

    // (bitwise-not)x2 truncates float to int see stackoverflow
    function int(val){ return ~~val; }

    function isPlayerX(){ return player === x; }
    // identify 3-in-a-row of current player
    function togglePlayer(){ player = isPlayerX() ? o : x; }
    // receives O or X in clicker, must decide if is winner
    //
    // sledgehammer: just go thru all possible winner configs
    // checking if winner matches one of them
    //
    function winsGame(clicker){
      let buttons = document.getElementsByTagName('button');
      for(let c = 0; c<winConfigs.length; c++){
        const w = winConfigs[c];
        // console.log(`Check if '${clicker}' matches winConfig ${w}`);

        if( // TODO is there a cleaner way to test this?
          buttons[w[0]].textContent === clicker &&
          buttons[w[1]].textContent === clicker &&
          buttons[w[2]].textContent === clicker 
        ){ 
          console.log(`Win, matches winConfig ${w}`);
          return true; 
        }

      }

      console.log(`No win..`);
      return false; 

    }

    // closure per button, with own row / col value
    //
    // caveat1: getElementsByTagName() before page loads, finds no buttons 
    //
    function initGame(event){
      console.log(`initGame(event=${event.type})`); //not event.name doh
      const buttons = document.getElementsByTagName('button');
      const SIDE = Math.sqrt(buttons.length);
      for (var i=0 ; i < buttons.length ; i++){
        (function(btn,row,col){

          btn.row = row;
          btn.col = col;
          btn.value = `row=${row}, col=${col}`;
          btn.classList.add('active');

          // onclick handles game logic
          //
          btn.onclick=function(){
            togglePlayer();
            // In firefox open console with CTRL+SHIFT+K
            console.log(`Player ${player} clicked: ${btn.value}`);
            btn.textContent = isPlayerX() ? x : o;
            // Lock button down after it is taken
            lockButton(btn);

            activeButtons--;
            if( winsGame(player) ){
              console.log(`Player ${player} wins!`);
              alert(`..you win..`);
              lockAllButtons(); 
            }
            else if( 0==activeButtons ){
              console.log(`Nobody wins!`);
              alert(`..you lose..`);
              lockAllButtons(); 
            }
          };

        })(buttons[i], int(1+i/SIDE), int(1+i%SIDE));
        activeButtons= buttons.length;
      }
    }

    function lockButton(btn){
      btn.onclick=null;
      btn.classList.remove('active');
      btn.classList.add('locked');
    }

    function lockAllButtons(){

      const buttons = document.getElementsByTagName('button');

      for( let i = 0; i<buttons.length; i++){
        lockButton(buttons[i]);
      }
    }
    // see caveat1 above; 'load' would delay till images loaded
    addEventListener("DOMContentLoaded", initGame);
  </script>

</head>

<body>
  <!--
  <script src="js/scripts.js"></script>
  -->
  <p>Example of basic html page</p>
  <p style="color: red">The <code>style</code> attribute can override both inline and external styles, though.</p>
  <h1>Table example</h1>

  <table>
    <thead>
      <tr>
        <th colspan="2">Tic Tac Toe (header)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><button>11</button></td>
        <td><button>12</button></td>
        <td><button>13</button></td>
      </tr>
      <tr>
        <td><button>21</button></td>
        <td><button>22</button></td>
        <td><button>23</button></td>
      </tr>
      <tr>
        <td><button>31</button></td>
        <td><button>32</button></td>
        <td><button>33</button></td>
      </tr>
    </tbody>
  </table>

</body>
</html>
